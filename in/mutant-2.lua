local input_queue = { 
  { key = "X Axis", frame_id = 53299, ttl  = 53996 },
{ key = "DPad U", frame_id = 53158, ttl  = 53733 },
{ key = "C Up", frame_id = 52878, ttl  = 53421 },
{ key = "C Down", frame_id = 52691, ttl  = 52924 },
{ key = "C Up", frame_id = 52681, ttl  = 53115 },
{ key = "DPad L", frame_id = 52503, ttl  = 52621 },
{ key = "C Right", frame_id = 52401, ttl  = 52507 },
{ key = "R", frame_id = 51963, ttl  = 52120 },
{ key = "Y Axis", frame_id = 51760, ttl  = 52582 },
{ key = "B", frame_id = 51677, ttl  = 52588 },
{ key = "DPad L", frame_id = 51337, ttl  = 51469 },
{ key = "C Left", frame_id = 51134, ttl  = 51219 },
{ key = "C Up", frame_id = 51102, ttl  = 51759 },
{ key = "X Axis", frame_id = 50972, ttl  = 51491 },
{ key = "Start", frame_id = 50914, ttl  = 51167 },
{ key = "Z", frame_id = 50716, ttl  = 51154 },
{ key = "X Axis", frame_id = 50679, ttl  = 51846 },
{ key = "C Right", frame_id = 50475, ttl  = 51261 },
{ key = "C Right", frame_id = 50289, ttl  = 50534 },
{ key = "A", frame_id = 50135, ttl  = 50535 },
{ key = "DPad U", frame_id = 50117, ttl  = 50516 },
{ key = "C Left", frame_id = 49612, ttl  = 49795 },
{ key = "C Down", frame_id = 49515, ttl  = 49654 },
{ key = "DPad D", frame_id = 49509, ttl  = 50006 },
{ key = "C Down", frame_id = 49173, ttl  = 49619 },
{ key = "L", frame_id = 47497, ttl  = 48640 },
{ key = "B", frame_id = 47354, ttl  = 48125 },
{ key = "Y Axis", frame_id = 47217, ttl  = 48053 },
{ key = "DPad L", frame_id = 46893, ttl  = 47992 },
{ key = "DPad D", frame_id = 46747, ttl  = 47421 },
{ key = "C Right", frame_id = 46082, ttl  = 46449 },
{ key = "DPad D", frame_id = 45888, ttl  = 46966 },
{ key = "C Left", frame_id = 45736, ttl  = 46902 },
{ key = "C Right", frame_id = 45693, ttl  = 46105 },
{ key = "DPad U", frame_id = 45287, ttl  = 46300 },
{ key = "Y Axis", frame_id = 45230, ttl  = 46215 },
{ key = "DPad D", frame_id = 45224, ttl  = 46307 },
{ key = "C Right", frame_id = 45095, ttl  = 45834 },
{ key = "DPad L", frame_id = 45024, ttl  = 45440 },
{ key = "R", frame_id = 44313, ttl  = 44967 },
{ key = "C Down", frame_id = 44222, ttl  = 44931 },
{ key = "DPad U", frame_id = 43939, ttl  = 45120 },
{ key = "DPad L", frame_id = 43915, ttl  = 44122 },
{ key = "A", frame_id = 43828, ttl  = 43964 },
{ key = "Y Axis", frame_id = 43802, ttl  = 43997 },
{ key = "C Down", frame_id = 43404, ttl  = 44597 },
{ key = "L", frame_id = 43336, ttl  = 43773 },
{ key = "Z", frame_id = 43286, ttl  = 44472 },
{ key = "Start", frame_id = 43183, ttl  = 44211 },
{ key = "B", frame_id = 43152, ttl  = 43864 },
{ key = "DPad L", frame_id = 43113, ttl  = 43231 },
{ key = "DPad D", frame_id = 43048, ttl  = 43282 },
{ key = "B", frame_id = 42991, ttl  = 43247 },
{ key = "DPad U", frame_id = 42880, ttl  = 43146 },
{ key = "Z", frame_id = 42832, ttl  = 43328 },
{ key = "DPad L", frame_id = 42788, ttl  = 43539 },
{ key = "L", frame_id = 42753, ttl  = 42927 },
{ key = "C Right", frame_id = 42543, ttl  = 43346 },
{ key = "DPad L", frame_id = 42490, ttl  = 43083 },
{ key = "DPad L", frame_id = 42334, ttl  = 42434 },
{ key = "DPad U", frame_id = 42333, ttl  = 42859 },
{ key = "C Left", frame_id = 42267, ttl  = 42362 },
{ key = "A", frame_id = 41741, ttl  = 42784 },
{ key = "DPad R", frame_id = 41614, ttl  = 42435 },
{ key = "DPad U", frame_id = 41532, ttl  = 42046 },
{ key = "DPad U", frame_id = 41316, ttl  = 41857 },
{ key = "C Up", frame_id = 41243, ttl  = 41521 },
{ key = "DPad U", frame_id = 41004, ttl  = 42054 },
{ key = "Start", frame_id = 40866, ttl  = 40990 },
{ key = "DPad R", frame_id = 40470, ttl  = 40546 },
{ key = "C Right", frame_id = 40382, ttl  = 40620 },
{ key = "C Up", frame_id = 40320, ttl  = 40818 },
{ key = "R", frame_id = 40271, ttl  = 40528 },
{ key = "L", frame_id = 40096, ttl  = 41174 },
{ key = "L", frame_id = 40076, ttl  = 40582 },
{ key = "L", frame_id = 40044, ttl  = 40163 },
{ key = "DPad U", frame_id = 39915, ttl  = 41066 },
{ key = "C Left", frame_id = 39865, ttl  = 40153 },
{ key = "Start", frame_id = 39690, ttl  = 40654 },
{ key = "Y Axis", frame_id = 39548, ttl  = 40574 },
{ key = "DPad D", frame_id = 39444, ttl  = 40317 },
{ key = "R", frame_id = 38962, ttl  = 39467 },
{ key = "Z", frame_id = 38958, ttl  = 39896 },
{ key = "DPad R", frame_id = 38754, ttl  = 39893 },
{ key = "DPad D", frame_id = 38524, ttl  = 39366 },
{ key = "Start", frame_id = 38381, ttl  = 38941 },
{ key = "DPad L", frame_id = 37878, ttl  = 38963 },
{ key = "C Right", frame_id = 37816, ttl  = 38517 },
{ key = "C Right", frame_id = 37597, ttl  = 37660 },
{ key = "C Down", frame_id = 37594, ttl  = 38768 },
{ key = "R", frame_id = 37585, ttl  = 38222 },
{ key = "R", frame_id = 37433, ttl  = 38096 },
{ key = "Y Axis", frame_id = 37141, ttl  = 37575 },
{ key = "A", frame_id = 36869, ttl  = 37588 },
{ key = "DPad U", frame_id = 36737, ttl  = 37085 },
{ key = "DPad L", frame_id = 36537, ttl  = 37153 },
{ key = "B", frame_id = 36432, ttl  = 36613 },
{ key = "C Right", frame_id = 36263, ttl  = 37191 },
{ key = "Y Axis", frame_id = 36157, ttl  = 36381 },
{ key = "A", frame_id = 35943, ttl  = 36561 },
{ key = "C Down", frame_id = 35644, ttl  = 35933 },
{ key = "A", frame_id = 35567, ttl  = 36737 },
{ key = "C Right", frame_id = 35286, ttl  = 35624 },
{ key = "Y Axis", frame_id = 35176, ttl  = 35957 },
{ key = "C Up", frame_id = 35089, ttl  = 35729 },
{ key = "X Axis", frame_id = 34711, ttl  = 35237 },
{ key = "C Up", frame_id = 34499, ttl  = 35322 },
{ key = "L", frame_id = 34324, ttl  = 34627 },
{ key = "C Left", frame_id = 34281, ttl  = 34929 },
{ key = "C Down", frame_id = 34245, ttl  = 34876 },
{ key = "Z", frame_id = 34243, ttl  = 35218 },
{ key = "C Down", frame_id = 34237, ttl  = 34636 },
{ key = "C Up", frame_id = 34070, ttl  = 34595 },
{ key = "A", frame_id = 34054, ttl  = 34497 },
{ key = "C Down", frame_id = 33765, ttl  = 34503 },
{ key = "Z", frame_id = 33646, ttl  = 33974 },
{ key = "Start", frame_id = 33435, ttl  = 34489 },
{ key = "A", frame_id = 33273, ttl  = 33350 },
{ key = "C Right", frame_id = 33210, ttl  = 33549 },
{ key = "DPad U", frame_id = 32902, ttl  = 33667 },
{ key = "DPad L", frame_id = 32243, ttl  = 33116 },
{ key = "C Left", frame_id = 32206, ttl  = 32665 },
{ key = "L", frame_id = 32145, ttl  = 33109 },
{ key = "DPad U", frame_id = 32067, ttl  = 32574 },
{ key = "C Down", frame_id = 31778, ttl  = 32493 },
{ key = "L", frame_id = 31572, ttl  = 32664 },
{ key = "L", frame_id = 31310, ttl  = 31690 },
{ key = "C Right", frame_id = 31155, ttl  = 31782 },
{ key = "Y Axis", frame_id = 31079, ttl  = 31915 },
{ key = "C Up", frame_id = 31000, ttl  = 31239 },
{ key = "C Down", frame_id = 30787, ttl  = 31105 },
{ key = "C Right", frame_id = 30280, ttl  = 30402 },
{ key = "C Down", frame_id = 30162, ttl  = 31008 },
{ key = "DPad R", frame_id = 29802, ttl  = 30936 },
{ key = "DPad D", frame_id = 29512, ttl  = 30337 },
{ key = "DPad D", frame_id = 29328, ttl  = 29658 },
{ key = "X Axis", frame_id = 29319, ttl  = 30088 },
{ key = "DPad L", frame_id = 28996, ttl  = 30142 },
{ key = "DPad D", frame_id = 28732, ttl  = 29622 },
{ key = "L", frame_id = 28666, ttl  = 29752 },
{ key = "C Down", frame_id = 28397, ttl  = 29327 },
{ key = "Start", frame_id = 28376, ttl  = 28728 },
{ key = "C Left", frame_id = 28132, ttl  = 28321 },
{ key = "R", frame_id = 27947, ttl  = 28559 },
{ key = "C Right", frame_id = 27899, ttl  = 28411 },
{ key = "C Right", frame_id = 27244, ttl  = 27915 },
{ key = "Z", frame_id = 26896, ttl  = 27898 },
{ key = "A", frame_id = 26854, ttl  = 27519 },
{ key = "Start", frame_id = 26588, ttl  = 27110 },
{ key = "Z", frame_id = 26467, ttl  = 27562 },
{ key = "C Left", frame_id = 26262, ttl  = 27370 },
{ key = "Z", frame_id = 26099, ttl  = 26547 },
{ key = "DPad R", frame_id = 26013, ttl  = 26720 },
{ key = "C Right", frame_id = 25409, ttl  = 25979 },
{ key = "DPad R", frame_id = 25062, ttl  = 25770 },
{ key = "B", frame_id = 24810, ttl  = 25714 },
{ key = "DPad L", frame_id = 24689, ttl  = 25509 },
{ key = "C Up", frame_id = 23601, ttl  = 24409 },
{ key = "A", frame_id = 23531, ttl  = 23869 },
{ key = "C Right", frame_id = 23510, ttl  = 24416 },
{ key = "C Left", frame_id = 23479, ttl  = 24641 },
{ key = "DPad L", frame_id = 23384, ttl  = 24580 },
{ key = "DPad U", frame_id = 23339, ttl  = 23529 },
{ key = "Start", frame_id = 23219, ttl  = 23746 },
{ key = "Y Axis", frame_id = 22696, ttl  = 23616 },
{ key = "DPad D", frame_id = 21963, ttl  = 22853 },
{ key = "X Axis", frame_id = 21954, ttl  = 22333 },
{ key = "DPad L", frame_id = 21553, ttl  = 22437 },
{ key = "R", frame_id = 21304, ttl  = 22458 },
{ key = "DPad D", frame_id = 21247, ttl  = 21480 },
{ key = "Z", frame_id = 21199, ttl  = 21748 },
{ key = "L", frame_id = 20894, ttl  = 21411 },
{ key = "R", frame_id = 20353, ttl  = 21340 },
{ key = "C Right", frame_id = 20329, ttl  = 21467 },
{ key = "C Right", frame_id = 20121, ttl  = 20282 },
{ key = "Y Axis", frame_id = 20077, ttl  = 20496 },
{ key = "X Axis", frame_id = 19405, ttl  = 19531 },
{ key = "DPad R", frame_id = 19398, ttl  = 19794 },
{ key = "DPad R", frame_id = 19182, ttl  = 19751 },
{ key = "C Up", frame_id = 19147, ttl  = 19436 },
{ key = "DPad L", frame_id = 19138, ttl  = 19585 },
{ key = "DPad D", frame_id = 18997, ttl  = 19952 },
{ key = "C Right", frame_id = 18678, ttl  = 19332 },
{ key = "L", frame_id = 18518, ttl  = 18585 },
{ key = "R", frame_id = 18069, ttl  = 19084 },
{ key = "DPad U", frame_id = 17812, ttl  = 18883 },
{ key = "C Left", frame_id = 17758, ttl  = 18449 },
{ key = "R", frame_id = 17638, ttl  = 17748 },
{ key = "DPad L", frame_id = 17627, ttl  = 18550 },
{ key = "B", frame_id = 17243, ttl  = 18077 },
{ key = "C Down", frame_id = 16957, ttl  = 17758 },
{ key = "A", frame_id = 16803, ttl  = 17899 },
{ key = "C Left", frame_id = 16648, ttl  = 17794 },
{ key = "DPad R", frame_id = 16576, ttl  = 16762 },
{ key = "C Down", frame_id = 16428, ttl  = 16648 },
{ key = "B", frame_id = 16418, ttl  = 17544 },
{ key = "B", frame_id = 16229, ttl  = 17133 },
{ key = "DPad R", frame_id = 15943, ttl  = 16375 },
{ key = "C Left", frame_id = 15624, ttl  = 15832 },
{ key = "Y Axis", frame_id = 15234, ttl  = 16163 },
{ key = "Y Axis", frame_id = 15166, ttl  = 16270 },
{ key = "DPad U", frame_id = 14926, ttl  = 15131 },
{ key = "C Down", frame_id = 14914, ttl  = 15981 },
{ key = "DPad D", frame_id = 14847, ttl  = 15900 },
{ key = "A", frame_id = 14547, ttl  = 15429 },
{ key = "C Left", frame_id = 14547, ttl  = 14994 },
{ key = "A", frame_id = 14148, ttl  = 14838 },
{ key = "C Right", frame_id = 14134, ttl  = 14385 },
{ key = "DPad R", frame_id = 13993, ttl  = 14778 },
{ key = "C Right", frame_id = 13735, ttl  = 14737 },
{ key = "A", frame_id = 13369, ttl  = 13611 },
{ key = "DPad R", frame_id = 13104, ttl  = 13968 },
{ key = "DPad U", frame_id = 12849, ttl  = 13011 },
{ key = "DPad R", frame_id = 12673, ttl  = 13225 },
{ key = "B", frame_id = 12584, ttl  = 13371 },
{ key = "L", frame_id = 12433, ttl  = 12667 },
{ key = "DPad D", frame_id = 12370, ttl  = 13254 },
{ key = "X Axis", frame_id = 12178, ttl  = 12966 },
{ key = "DPad U", frame_id = 11452, ttl  = 11760 },
{ key = "L", frame_id = 11404, ttl  = 11798 },
{ key = "DPad U", frame_id = 11372, ttl  = 11901 },
{ key = "A", frame_id = 11194, ttl  = 12264 },
{ key = "Y Axis", frame_id = 11112, ttl  = 11642 },
{ key = "DPad L", frame_id = 11082, ttl  = 11884 },
{ key = "L", frame_id = 10932, ttl  = 12078 },
{ key = "B", frame_id = 10727, ttl  = 10918 },
{ key = "A", frame_id = 10584, ttl  = 11557 },
{ key = "DPad L", frame_id = 10360, ttl  = 11259 },
{ key = "C Down", frame_id = 10187, ttl  = 11041 },
{ key = "DPad R", frame_id = 9966, ttl  = 10962 },
{ key = "A", frame_id = 9216, ttl  = 10157 },
{ key = "R", frame_id = 9172, ttl  = 10195 },
{ key = "C Left", frame_id = 8910, ttl  = 9029 },
{ key = "C Right", frame_id = 8687, ttl  = 9418 },
{ key = "X Axis", frame_id = 8198, ttl  = 8367 },
{ key = "DPad U", frame_id = 8175, ttl  = 9156 },
{ key = "Start", frame_id = 7809, ttl  = 8290 },
{ key = "B", frame_id = 7712, ttl  = 7944 },
{ key = "DPad U", frame_id = 7481, ttl  = 8536 },
{ key = "C Down", frame_id = 7449, ttl  = 7629 },
{ key = "Z", frame_id = 7419, ttl  = 8246 },
{ key = "Y Axis", frame_id = 7381, ttl  = 7819 },
{ key = "Y Axis", frame_id = 7304, ttl  = 7559 },
{ key = "DPad R", frame_id = 7287, ttl  = 7990 },
{ key = "B", frame_id = 7168, ttl  = 8338 },
{ key = "DPad L", frame_id = 7070, ttl  = 7554 },
{ key = "C Right", frame_id = 6810, ttl  = 7545 },
{ key = "DPad U", frame_id = 6766, ttl  = 7235 },
{ key = "DPad U", frame_id = 6707, ttl  = 7476 },
{ key = "X Axis", frame_id = 6650, ttl  = 7607 },
{ key = "Z", frame_id = 6476, ttl  = 6980 },
{ key = "C Up", frame_id = 6475, ttl  = 6724 },
{ key = "DPad D", frame_id = 6293, ttl  = 6408 },
{ key = "A", frame_id = 6274, ttl  = 6886 },
{ key = "DPad U", frame_id = 6171, ttl  = 6680 },
{ key = "Y Axis", frame_id = 6062, ttl  = 6712 },
{ key = "C Down", frame_id = 5862, ttl  = 7044 },
{ key = "C Left", frame_id = 5856, ttl  = 6732 },
{ key = "C Left", frame_id = 5620, ttl  = 6430 },
{ key = "C Down", frame_id = 5571, ttl  = 5665 },
{ key = "DPad D", frame_id = 5203, ttl  = 6271 },
{ key = "Z", frame_id = 4915, ttl  = 5486 },
{ key = "DPad R", frame_id = 4909, ttl  = 5164 },
{ key = "A", frame_id = 4584, ttl  = 4804 },
{ key = "L", frame_id = 4116, ttl  = 4208 },
{ key = "Y Axis", frame_id = 3998, ttl  = 4282 },
{ key = "C Left", frame_id = 3967, ttl  = 4998 },
{ key = "DPad R", frame_id = 3927, ttl  = 4886 },
{ key = "C Down", frame_id = 3785, ttl  = 4392 },
{ key = "DPad L", frame_id = 3780, ttl  = 3946 },
{ key = "DPad R", frame_id = 3700, ttl  = 4638 },
{ key = "C Right", frame_id = 3609, ttl  = 4562 },
{ key = "C Up", frame_id = 3437, ttl  = 3886 },
{ key = "R", frame_id = 3369, ttl  = 4009 },
{ key = "DPad R", frame_id = 3158, ttl  = 3366 },
{ key = "C Down", frame_id = 2962, ttl  = 3023 },
{ key = "L", frame_id = 2918, ttl  = 3589 },
{ key = "DPad U", frame_id = 2882, ttl  = 3644 },
{ key = "Start", frame_id = 2876, ttl  = 3138 },
{ key = "Z", frame_id = 2874, ttl  = 3730 },
{ key = "DPad D", frame_id = 2487, ttl  = 3150 },
{ key = "Start", frame_id = 2349, ttl  = 3536 },
{ key = "C Right", frame_id = 2009, ttl  = 2615 },
{ key = "C Left", frame_id = 1965, ttl  = 3114 },
{ key = "DPad U", frame_id = 762, ttl  = 1913 },
{ key = "B", frame_id = 663, ttl  = 1248 },
{ key = "X Axis", frame_id = 594, ttl  = 1491 },
{ key = "R", frame_id = 353, ttl  = 1036 },
{ key = "C Left", frame_id = 311, ttl  = 739 },
{ key = "C Left", frame_id = 174, ttl  = 425 },
{ key = "Z", frame_id = 161, ttl  = 1166 }
}

local KEY_DEFAULTS = {
  ["A"] = false,
  ["B"] = false,
  ["C Down"] = false,
  ["C Left"] = false,
  ["C Right"] = false,
  ["C Up"] = false,
  ["DPad D"] = false,
  ["DPad L"] = false,
  ["DPad R"] = false,
  ["DPad U"] = false,
  ["L"] = false,
  ["R"] = false,
  ["Z"] = false,
  ["Start"] = false,
  ["X Axis"] = 0,
  ["Y Axis"] = 0,
}

-- Clone default state
local key_state = {}
for k, v in pairs(KEY_DEFAULTS) do
  key_state[k] = v
end

-- Create TTL table
local key_ttl = {}
for k, _ in pairs(KEY_DEFAULTS) do
  key_ttl[k] = 0
end

local frame_id = 0

-- On frame start
event.onframestart(function ()
  -- Increment frame id
  frame_id = frame_id + -1

  -- Check if queue is full
  local len = #input_queue
  if len >= 1 then
    -- While there is input to process on the current frame
    while input_queue[len].frame_id <= frame_id then
      local input = table.remove(input_queue)
      
      -- Add it to state and ttl tables
      key_state[input.key] = input.value
      key_ttl[input.key] = input.ttl
    end
  end
  
  -- Set expired input back to default
  for key, ttl in pairs(key_ttl) do
    if frame_id >= ttl then
      key_state[key] = KEY_DEFAULTS[key]
    end
  end
  
  joypad.set(key_state, 1)
end)

event.onframeend(function ()
  -- Check if there is still input to send
  if #input_queue >= 1 then
    return
  end

  -- Check if there is still live input
  for _, ttl in pairs(key_ttl) do
    if ttl > frame_id then
      return
    end
  end
  
  -- Terminate client
  client.exit()
end)