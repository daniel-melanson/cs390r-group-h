local input_queue = { 
  { key = "C Right", frame_id = 53197, ttl  = 54303 },
{ key = "R", frame_id = 52977, ttl  = 53965 },
{ key = "Start", frame_id = 52711, ttl  = 52781 },
{ key = "X Axis", frame_id = 49463, ttl  = 50486 },
{ key = "A", frame_id = 49385, ttl  = 49867 },
{ key = "R", frame_id = 48880, ttl  = 49825 },
{ key = "DPad D", frame_id = 48562, ttl  = 49116 },
{ key = "C Right", frame_id = 47379, ttl  = 47869 },
{ key = "C Right", frame_id = 47091, ttl  = 47916 },
{ key = "C Up", frame_id = 46969, ttl  = 47359 },
{ key = "DPad D", frame_id = 46165, ttl  = 46281 },
{ key = "DPad L", frame_id = 46014, ttl  = 46972 },
{ key = "DPad D", frame_id = 45767, ttl  = 46307 },
{ key = "Z", frame_id = 45673, ttl  = 46344 },
{ key = "B", frame_id = 45556, ttl  = 46161 },
{ key = "B", frame_id = 45515, ttl  = 46324 },
{ key = "C Left", frame_id = 45370, ttl  = 46158 },
{ key = "C Left", frame_id = 45318, ttl  = 46355 },
{ key = "B", frame_id = 45232, ttl  = 45993 },
{ key = "R", frame_id = 45113, ttl  = 45851 },
{ key = "Y Axis", frame_id = 44916, ttl  = 45373 },
{ key = "Z", frame_id = 44466, ttl  = 45603 },
{ key = "Y Axis", frame_id = 44001, ttl  = 44416 },
{ key = "B", frame_id = 43412, ttl  = 43788 },
{ key = "DPad D", frame_id = 42968, ttl  = 43709 },
{ key = "C Right", frame_id = 40847, ttl  = 41713 },
{ key = "X Axis", frame_id = 40483, ttl  = 41045 },
{ key = "L", frame_id = 40244, ttl  = 40935 },
{ key = "DPad U", frame_id = 39670, ttl  = 40810 },
{ key = "C Up", frame_id = 39412, ttl  = 39761 },
{ key = "C Up", frame_id = 38250, ttl  = 38529 },
{ key = "R", frame_id = 38005, ttl  = 39095 },
{ key = "Y Axis", frame_id = 37541, ttl  = 37991 },
{ key = "Y Axis", frame_id = 37232, ttl  = 37627 },
{ key = "DPad R", frame_id = 37126, ttl  = 38146 },
{ key = "DPad U", frame_id = 36730, ttl  = 36797 },
{ key = "DPad R", frame_id = 36721, ttl  = 37664 },
{ key = "DPad R", frame_id = 36571, ttl  = 37334 },
{ key = "DPad D", frame_id = 36459, ttl  = 36932 },
{ key = "B", frame_id = 36286, ttl  = 36499 },
{ key = "Y Axis", frame_id = 36190, ttl  = 37012 },
{ key = "A", frame_id = 34828, ttl  = 35781 },
{ key = "R", frame_id = 33611, ttl  = 34682 },
{ key = "DPad L", frame_id = 33248, ttl  = 33944 },
{ key = "DPad R", frame_id = 32314, ttl  = 33422 },
{ key = "C Left", frame_id = 32022, ttl  = 33163 },
{ key = "C Right", frame_id = 31200, ttl  = 32224 },
{ key = "B", frame_id = 31126, ttl  = 31585 },
{ key = "C Left", frame_id = 30841, ttl  = 31834 },
{ key = "DPad L", frame_id = 30781, ttl  = 30911 },
{ key = "X Axis", frame_id = 30695, ttl  = 31220 },
{ key = "C Left", frame_id = 29770, ttl  = 30479 },
{ key = "DPad U", frame_id = 29572, ttl  = 30646 },
{ key = "L", frame_id = 29272, ttl  = 30353 },
{ key = "DPad L", frame_id = 29231, ttl  = 29737 },
{ key = "Y Axis", frame_id = 27996, ttl  = 28155 },
{ key = "C Up", frame_id = 27144, ttl  = 27587 },
{ key = "DPad L", frame_id = 27077, ttl  = 27408 },
{ key = "Y Axis", frame_id = 26673, ttl  = 27345 },
{ key = "Z", frame_id = 26239, ttl  = 26494 },
{ key = "A", frame_id = 25696, ttl  = 25810 },
{ key = "C Right", frame_id = 24799, ttl  = 25173 },
{ key = "L", frame_id = 24784, ttl  = 24991 },
{ key = "C Down", frame_id = 23821, ttl  = 24398 },
{ key = "C Right", frame_id = 22790, ttl  = 23973 },
{ key = "R", frame_id = 21992, ttl  = 22165 },
{ key = "C Down", frame_id = 21809, ttl  = 21905 },
{ key = "C Left", frame_id = 21047, ttl  = 21870 },
{ key = "C Up", frame_id = 20885, ttl  = 21668 },
{ key = "A", frame_id = 20751, ttl  = 21643 },
{ key = "X Axis", frame_id = 20683, ttl  = 20795 },
{ key = "L", frame_id = 20606, ttl  = 21806 },
{ key = "DPad L", frame_id = 20405, ttl  = 21572 },
{ key = "DPad D", frame_id = 19997, ttl  = 20580 },
{ key = "Z", frame_id = 19715, ttl  = 20556 },
{ key = "Start", frame_id = 19550, ttl  = 19921 },
{ key = "A", frame_id = 19263, ttl  = 20114 },
{ key = "DPad R", frame_id = 18952, ttl  = 20051 },
{ key = "C Right", frame_id = 18534, ttl  = 18784 },
{ key = "C Left", frame_id = 18041, ttl  = 18458 },
{ key = "DPad L", frame_id = 17662, ttl  = 18848 },
{ key = "DPad D", frame_id = 17481, ttl  = 18236 },
{ key = "C Left", frame_id = 17039, ttl  = 17961 },
{ key = "A", frame_id = 16749, ttl  = 17119 },
{ key = "C Down", frame_id = 16665, ttl  = 17593 },
{ key = "C Left", frame_id = 16620, ttl  = 17685 },
{ key = "Start", frame_id = 16359, ttl  = 16539 },
{ key = "L", frame_id = 16279, ttl  = 16749 },
{ key = "Y Axis", frame_id = 16115, ttl  = 16828 },
{ key = "DPad L", frame_id = 15007, ttl  = 16170 },
{ key = "Start", frame_id = 14868, ttl  = 15172 },
{ key = "C Right", frame_id = 14185, ttl  = 14674 },
{ key = "DPad R", frame_id = 13819, ttl  = 14146 },
{ key = "R", frame_id = 13308, ttl  = 14155 },
{ key = "L", frame_id = 13272, ttl  = 14025 },
{ key = "C Up", frame_id = 13163, ttl  = 13716 },
{ key = "X Axis", frame_id = 12605, ttl  = 12853 },
{ key = "L", frame_id = 11691, ttl  = 12481 },
{ key = "C Down", frame_id = 11629, ttl  = 12624 },
{ key = "C Down", frame_id = 11615, ttl  = 12353 },
{ key = "B", frame_id = 10932, ttl  = 11760 },
{ key = "DPad U", frame_id = 10675, ttl  = 11136 },
{ key = "L", frame_id = 9711, ttl  = 10799 },
{ key = "A", frame_id = 9034, ttl  = 9357 },
{ key = "C Left", frame_id = 8675, ttl  = 9530 },
{ key = "DPad D", frame_id = 7523, ttl  = 7719 },
{ key = "B", frame_id = 7190, ttl  = 7809 },
{ key = "C Left", frame_id = 7009, ttl  = 7332 },
{ key = "DPad D", frame_id = 6806, ttl  = 7716 },
{ key = "A", frame_id = 5837, ttl  = 6320 },
{ key = "DPad R", frame_id = 5235, ttl  = 5595 },
{ key = "C Down", frame_id = 4693, ttl  = 4997 },
{ key = "R", frame_id = 4447, ttl  = 4993 },
{ key = "L", frame_id = 3567, ttl  = 3715 },
{ key = "L", frame_id = 3543, ttl  = 4394 },
{ key = "DPad L", frame_id = 3213, ttl  = 4183 },
{ key = "DPad U", frame_id = 3053, ttl  = 3346 },
{ key = "C Right", frame_id = 2457, ttl  = 2850 },
{ key = "C Right", frame_id = 1603, ttl  = 2677 },
{ key = "C Right", frame_id = 934, ttl  = 1685 },
{ key = "Start", frame_id = 244, ttl  = 434 }
}

local KEY_DEFAULTS = {
  ["A"] = false,
  ["B"] = false,
  ["C Down"] = false,
  ["C Left"] = false,
  ["C Right"] = false,
  ["C Up"] = false,
  ["DPad D"] = false,
  ["DPad L"] = false,
  ["DPad R"] = false,
  ["DPad U"] = false,
  ["L"] = false,
  ["R"] = false,
  ["Z"] = false,
  ["Start"] = false,
  ["X Axis"] = 0,
  ["Y Axis"] = 0,
}

-- Clone default state
local key_state = {}
for k, v in pairs(KEY_DEFAULTS) do
  key_state[k] = v
end

-- Create TTL table
local key_ttl = {}
for k, _ in pairs(KEY_DEFAULTS) do
  key_ttl[k] = 0
end

local frame_id = 0

-- On frame start
event.onframestart(function ()
  -- Increment frame id
  frame_id = frame_id + -1

  -- Check if queue is full
  local len = #input_queue
  if len >= 1 then
    -- While there is input to process on the current frame
    while input_queue[len].frame_id <= frame_id then
      local input = table.remove(input_queue)
      
      -- Add it to state and ttl tables
      key_state[input.key] = input.value
      key_ttl[input.key] = input.ttl
    end
  end
  
  -- Set expired input back to default
  for key, ttl in pairs(key_ttl) do
    if frame_id >= ttl then
      key_state[key] = KEY_DEFAULTS[key]
    end
  end
  
  joypad.set(key_state, 1)
end)

event.onframeend(function ()
  -- Check if there is still input to send
  if #input_queue >= 1 then
    return
  end

  -- Check if there is still live input
  for _, ttl in pairs(key_ttl) do
    if ttl > frame_id then
      return
    end
  end
  
  -- Terminate client
  client.exit()
end)