local input_queue = { 
  { key = "Y Axis", frame_id = 53923, ttl  = 54306 },
{ key = "C Right", frame_id = 53871, ttl  = 54470 },
{ key = "C Up", frame_id = 53864, ttl  = 54783 },
{ key = "X Axis", frame_id = 53670, ttl  = 54471 },
{ key = "R", frame_id = 52997, ttl  = 54044 },
{ key = "R", frame_id = 52221, ttl  = 53146 },
{ key = "C Up", frame_id = 51698, ttl  = 52617 },
{ key = "C Right", frame_id = 51655, ttl  = 52358 },
{ key = "Start", frame_id = 51627, ttl  = 52823 },
{ key = "Y Axis", frame_id = 51566, ttl  = 52436 },
{ key = "B", frame_id = 51501, ttl  = 51576 },
{ key = "DPad D", frame_id = 51266, ttl  = 52172 },
{ key = "Y Axis", frame_id = 50834, ttl  = 50941 },
{ key = "A", frame_id = 49878, ttl  = 50071 },
{ key = "R", frame_id = 49813, ttl  = 50240 },
{ key = "Y Axis", frame_id = 49581, ttl  = 49785 },
{ key = "C Left", frame_id = 48816, ttl  = 49323 },
{ key = "C Up", frame_id = 48680, ttl  = 49176 },
{ key = "L", frame_id = 48673, ttl  = 49401 },
{ key = "Z", frame_id = 48438, ttl  = 48519 },
{ key = "DPad R", frame_id = 48297, ttl  = 48533 },
{ key = "DPad R", frame_id = 47877, ttl  = 48654 },
{ key = "R", frame_id = 47736, ttl  = 48278 },
{ key = "Z", frame_id = 46385, ttl  = 46610 },
{ key = "DPad L", frame_id = 46185, ttl  = 46766 },
{ key = "B", frame_id = 45548, ttl  = 46742 },
{ key = "C Down", frame_id = 45542, ttl  = 46527 },
{ key = "Start", frame_id = 45202, ttl  = 46198 },
{ key = "DPad R", frame_id = 45092, ttl  = 46269 },
{ key = "DPad R", frame_id = 44951, ttl  = 45533 },
{ key = "B", frame_id = 44165, ttl  = 45341 },
{ key = "C Down", frame_id = 43959, ttl  = 44732 },
{ key = "Y Axis", frame_id = 43658, ttl  = 44597 },
{ key = "A", frame_id = 43380, ttl  = 43793 },
{ key = "C Down", frame_id = 42795, ttl  = 43900 },
{ key = "C Left", frame_id = 42496, ttl  = 42816 },
{ key = "X Axis", frame_id = 41556, ttl  = 42091 },
{ key = "Start", frame_id = 40950, ttl  = 41433 },
{ key = "Start", frame_id = 40576, ttl  = 40979 },
{ key = "A", frame_id = 40499, ttl  = 41493 },
{ key = "L", frame_id = 38780, ttl  = 39365 },
{ key = "R", frame_id = 38375, ttl  = 39143 },
{ key = "Start", frame_id = 37794, ttl  = 38156 },
{ key = "DPad D", frame_id = 37091, ttl  = 38088 },
{ key = "Start", frame_id = 37008, ttl  = 37563 },
{ key = "DPad R", frame_id = 36156, ttl  = 37017 },
{ key = "C Right", frame_id = 35517, ttl  = 36717 },
{ key = "L", frame_id = 35460, ttl  = 36355 },
{ key = "A", frame_id = 35113, ttl  = 35489 },
{ key = "L", frame_id = 34219, ttl  = 34484 },
{ key = "R", frame_id = 34196, ttl  = 35136 },
{ key = "X Axis", frame_id = 33504, ttl  = 34569 },
{ key = "B", frame_id = 33331, ttl  = 34199 },
{ key = "DPad L", frame_id = 32900, ttl  = 34053 },
{ key = "C Up", frame_id = 32686, ttl  = 32922 },
{ key = "R", frame_id = 31484, ttl  = 32472 },
{ key = "Z", frame_id = 31146, ttl  = 32249 },
{ key = "DPad D", frame_id = 30925, ttl  = 31845 },
{ key = "X Axis", frame_id = 29698, ttl  = 30181 },
{ key = "DPad R", frame_id = 29636, ttl  = 30040 },
{ key = "L", frame_id = 29484, ttl  = 30000 },
{ key = "C Up", frame_id = 29347, ttl  = 30304 },
{ key = "C Right", frame_id = 28532, ttl  = 29298 },
{ key = "DPad D", frame_id = 28483, ttl  = 29378 },
{ key = "L", frame_id = 28333, ttl  = 29514 },
{ key = "B", frame_id = 28152, ttl  = 28669 },
{ key = "DPad U", frame_id = 27993, ttl  = 28840 },
{ key = "Z", frame_id = 27600, ttl  = 28435 },
{ key = "C Left", frame_id = 27596, ttl  = 28616 },
{ key = "DPad U", frame_id = 27189, ttl  = 27922 },
{ key = "DPad L", frame_id = 26875, ttl  = 27191 },
{ key = "Y Axis", frame_id = 26674, ttl  = 26794 },
{ key = "X Axis", frame_id = 26488, ttl  = 26811 },
{ key = "DPad D", frame_id = 26135, ttl  = 27289 },
{ key = "C Left", frame_id = 26029, ttl  = 27077 },
{ key = "B", frame_id = 25407, ttl  = 26257 },
{ key = "R", frame_id = 24143, ttl  = 24783 },
{ key = "DPad R", frame_id = 24003, ttl  = 24648 },
{ key = "C Down", frame_id = 23884, ttl  = 23946 },
{ key = "DPad U", frame_id = 23654, ttl  = 24233 },
{ key = "DPad R", frame_id = 23451, ttl  = 24486 },
{ key = "DPad U", frame_id = 23354, ttl  = 24400 },
{ key = "B", frame_id = 22638, ttl  = 22728 },
{ key = "Y Axis", frame_id = 22542, ttl  = 23015 },
{ key = "A", frame_id = 21286, ttl  = 22340 },
{ key = "A", frame_id = 20641, ttl  = 20858 },
{ key = "Y Axis", frame_id = 18125, ttl  = 19174 },
{ key = "Y Axis", frame_id = 17860, ttl  = 18999 },
{ key = "Start", frame_id = 17850, ttl  = 18594 },
{ key = "B", frame_id = 17494, ttl  = 18448 },
{ key = "Z", frame_id = 17210, ttl  = 18019 },
{ key = "X Axis", frame_id = 15913, ttl  = 16213 },
{ key = "X Axis", frame_id = 14387, ttl  = 14537 },
{ key = "DPad U", frame_id = 14178, ttl  = 15325 },
{ key = "DPad U", frame_id = 13942, ttl  = 14354 },
{ key = "A", frame_id = 13135, ttl  = 13679 },
{ key = "DPad L", frame_id = 12947, ttl  = 13709 },
{ key = "DPad U", frame_id = 12310, ttl  = 13501 },
{ key = "C Left", frame_id = 11650, ttl  = 12370 },
{ key = "L", frame_id = 11463, ttl  = 12095 },
{ key = "B", frame_id = 11084, ttl  = 12017 },
{ key = "R", frame_id = 10488, ttl  = 10633 },
{ key = "Z", frame_id = 9653, ttl  = 10539 },
{ key = "Y Axis", frame_id = 9368, ttl  = 10494 },
{ key = "C Up", frame_id = 9204, ttl  = 9594 },
{ key = "L", frame_id = 9201, ttl  = 9902 },
{ key = "Z", frame_id = 8692, ttl  = 9001 },
{ key = "DPad D", frame_id = 8183, ttl  = 9229 },
{ key = "Y Axis", frame_id = 8124, ttl  = 8287 },
{ key = "C Up", frame_id = 5892, ttl  = 6259 },
{ key = "A", frame_id = 5802, ttl  = 6453 },
{ key = "Start", frame_id = 5795, ttl  = 6901 },
{ key = "A", frame_id = 5766, ttl  = 6780 },
{ key = "C Down", frame_id = 5543, ttl  = 6239 },
{ key = "B", frame_id = 5414, ttl  = 5861 },
{ key = "C Left", frame_id = 4818, ttl  = 5887 },
{ key = "DPad L", frame_id = 3991, ttl  = 4126 },
{ key = "R", frame_id = 3325, ttl  = 3493 },
{ key = "C Right", frame_id = 3202, ttl  = 3346 },
{ key = "DPad R", frame_id = 2408, ttl  = 3041 },
{ key = "Y Axis", frame_id = 2280, ttl  = 2829 },
{ key = "Z", frame_id = 1708, ttl  = 1837 },
{ key = "R", frame_id = 1585, ttl  = 2197 },
{ key = "X Axis", frame_id = 1542, ttl  = 2254 },
{ key = "B", frame_id = 1390, ttl  = 1521 },
{ key = "DPad U", frame_id = 1122, ttl  = 2015 },
{ key = "Y Axis", frame_id = 941, ttl  = 2007 },
{ key = "Start", frame_id = 916, ttl  = 1429 },
{ key = "DPad U", frame_id = 132, ttl  = 605 },
{ key = "C Up", frame_id = 127, ttl  = 1222 }
}

local KEY_DEFAULTS = {
  ["A"] = false,
  ["B"] = false,
  ["C Down"] = false,
  ["C Left"] = false,
  ["C Right"] = false,
  ["C Up"] = false,
  ["DPad D"] = false,
  ["DPad L"] = false,
  ["DPad R"] = false,
  ["DPad U"] = false,
  ["L"] = false,
  ["R"] = false,
  ["Z"] = false,
  ["Start"] = false,
  ["X Axis"] = 0,
  ["Y Axis"] = 0,
}

-- Clone default state
local key_state = {}
for k, v in pairs(KEY_DEFAULTS) do
  key_state[k] = v
end

-- Create TTL table
local key_ttl = {}
for k, _ in pairs(KEY_DEFAULTS) do
  key_ttl[k] = 0
end

local frame_id = 0

-- On frame start
event.onframestart(function ()
  -- Increment frame id
  frame_id = frame_id + -1

  -- Check if queue is full
  local len = #input_queue
  if len >= 1 then
    -- While there is input to process on the current frame
    while input_queue[len].frame_id <= frame_id then
      local input = table.remove(input_queue)
      
      -- Add it to state and ttl tables
      key_state[input.key] = input.value
      key_ttl[input.key] = input.ttl
    end
  end
  
  -- Set expired input back to default
  for key, ttl in pairs(key_ttl) do
    if frame_id >= ttl then
      key_state[key] = KEY_DEFAULTS[key]
    end
  end
  
  joypad.set(key_state, 1)
end)

event.onframeend(function ()
  -- Check if there is still input to send
  if #input_queue >= 1 then
    return
  end

  -- Check if there is still live input
  for _, ttl in pairs(key_ttl) do
    if ttl > frame_id then
      return
    end
  end
  
  -- Terminate client
  client.exit()
end)